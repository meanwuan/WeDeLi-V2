<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WeDeli Admin - Qu·∫£n l√Ω Nh√† Xe</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #4A90E2;
      --primary-dark: #357ACB;
      --success: #5cb85c;
      --warning: #f0ad4e;
      --danger: #d9534f;
      --dark: #2c3e50;
      --light: #ecf0f1;
      --border: #dfe6e9;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--dark);
      color: white;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .sidebar-header {
      padding: 20px;
      background: var(--primary);
      text-align: center;
    }

    .sidebar-header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .sidebar-header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .nav-menu {
      flex: 1;
      padding: 10px 0;
      overflow-y: auto;
    }

    .nav-item {
      padding: 15px 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      border-left: 3px solid transparent;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .nav-item.active {
      background: rgba(74,144,226,0.2);
      border-left-color: var(--primary);
    }

    .nav-item .icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .header {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title h2 {
      color: var(--dark);
      font-size: 24px;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(74,144,226,0.3);
    }

    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: white; }
    .btn-danger { background: var(--danger); color: white; }

    /* Content Area */
    .content {
      flex: 1;
      padding: 25px 30px;
      overflow-y: auto;
    }

    .section {
      display: none;
    }

    .section.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      gap: 15px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .stat-icon.blue { background: rgba(74,144,226,0.15); color: var(--primary); }
    .stat-icon.green { background: rgba(92,184,92,0.15); color: var(--success); }
    .stat-icon.orange { background: rgba(240,173,78,0.15); color: var(--warning); }
    .stat-icon.red { background: rgba(217,83,79,0.15); color: var(--danger); }

    .stat-info h3 {
      font-size: 28px;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .stat-info p {
      color: #7f8c8d;
      font-size: 14px;
    }

    /* Table */
    .table-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      overflow-x: auto;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
     align-items: center;
      margin-bottom: 20px;
    }

    .table-header h3 {
      font-size: 18px;
      color: var(--dark);
    }

    .search-box {
      padding: 8px 15px;
      border: 1px solid var(--border);
      border-radius: 6px;
      width: 250px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 2px solid var(--border);
    }

    td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      color: #2c3e50;
    }

    tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }

    .badge-success { background: #d4edda; color: #155724; }
    .badge-warning { background: #fff3cd; color: #856404; }
    .badge-danger { background: #f8d7da; color: #721c24; }
    .badge-info { background: #d1ecf1; color: #0c5460; }

    /* Map */
    #map {
      height: 500px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: slideDown 0.3s;
    }

    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 20px;
      color: var(--dark);
    }

    .close-btn {
      font-size: 24px;
      cursor: pointer;
      color: #7f8c8d;
      background: none;
      border: none;
    }

    .modal-body {
      padding: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Alert Banner */
    .alert-banner {
      padding: 15px 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .alert-icon {
      font-size: 24px;
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>üöö WeDeli</h1>
        <p>H·ªá th·ªëng qu·∫£n l√Ω nh√† xe</p>
      </div>
      
      <div class="nav-menu">
        <div class="nav-item active" onclick="showSection('dashboard')">
          <span class="icon">üìä</span>
          <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="showSection('orders')">
          <span class="icon">üì¶</span>
          <span>Qu·∫£n l√Ω ƒë∆°n h√†ng</span>
        </div>
        <div class="nav-item" onclick="showSection('vehicles')">
          <span class="icon">üöõ</span>
          <span>Qu·∫£n l√Ω xe</span>
        </div>
        <div class="nav-item" onclick="showSection('drivers')">
          <span class="icon">üë®‚Äç‚úàÔ∏è</span>
          <span>T√†i x·∫ø</span>
        </div>
        <div class="nav-item" onclick="showSection('customers')">
          <span class="icon">üë•</span>
          <span>Kh√°ch h√†ng</span>
        </div>
        <div class="nav-item" onclick="showSection('reports')">
          <span class="icon">üìà</span>
          <span>B√°o c√°o</span>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Header -->
      <div class="header">
        <div class="header-title">
          <h2 id="page-title">Dashboard</h2>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="showModal('create-order')">
            ‚ûï T·∫°o ƒë∆°n h√†ng
          </button>
          <button class="btn btn-success" onclick="loadDashboard()">
            üîÑ L√†m m·ªõi
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue">üì¶</div>
              <div class="stat-info">
                <h3 id="stat-total-orders">0</h3>
                <p>T·ªïng ƒë∆°n h√†ng</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon green">‚úÖ</div>
              <div class="stat-info">
                <h3 id="stat-delivered">0</h3>
                <p>ƒê√£ giao th√†nh c√¥ng</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon orange">üöõ</div>
              <div class="stat-info">
                <h3 id="stat-vehicles">0</h3>
                <p>Xe ƒëang ho·∫°t ƒë·ªông</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon red">üí∞</div>
              <div class="stat-info">
                <h3 id="stat-revenue">0‚Ç´</h3>
                <p>Doanh thu h√¥m nay</p>
              </div>
            </div>
          </div>

          <div class="table-container" style="margin-bottom: 20px;">
            <div class="table-header">
              <h3>üö® C·∫£nh b√°o xe qu√° t·∫£i</h3>
            </div>
            <div id="overload-alerts"></div>
          </div>

          <div id="map"></div>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="section">
          <div class="table-container">
            <div class="table-header">
              <h3>üì¶ Danh s√°ch ƒë∆°n h√†ng</h3>
              <input type="text" class="search-box" placeholder="üîç T√¨m m√£ v·∫≠n ƒë∆°n..." onkeyup="searchOrders(this.value)">
            </div>
            <table id="orders-table">
              <thead>
                <tr>
                  <th>M√£ v·∫≠n ƒë∆°n</th>
                  <th>Kh√°ch h√†ng</th>
                  <th>T·ª´ ‚Üí ƒê·∫øn</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Xe</th>
                  <th>Ph√≠ ship</th>
                  <th>COD</th>
                  <th>Thanh to√°n</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="orders-tbody">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Vehicles Section -->
        <div id="vehicles" class="section">
          <div class="table-container">
            <div class="table-header">
              <h3>üöõ Danh s√°ch xe</h3>
              <button class="btn btn-primary" onclick="showModal('add-vehicle')">‚ûï Th√™m xe</button>
            </div>
            <table id="vehicles-table">
              <thead>
                <tr>
                  <th>Bi·ªÉn s·ªë</th>
                  <th>Lo·∫°i xe</th>
                  <th>T·∫£i tr·ªçng</th>
                  <th>Hi·ªán t·∫°i</th>
                  <th>% T·∫£i</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="vehicles-tbody">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Drivers Section -->
        <div id="drivers" class="section">
          <div class="table-container">
            <div class="table-header">
              <h3>üë®‚Äç‚úàÔ∏è Danh s√°ch t√†i x·∫ø</h3>
              <button class="btn btn-primary" onclick="showModal('add-driver')">‚ûï Th√™m t√†i x·∫ø</button>
            </div>
            <table>
              <thead>
                <tr>
                  <th>H·ªç t√™n</th>
                  <th>SƒêT</th>
                  <th>B·∫±ng l√°i</th>
                  <th>T·ªïng chuy·∫øn</th>
                  <th>ƒê√°nh gi√°</th>
                  <th>Tr·∫°ng th√°i</th>
                </tr>
              </thead>
              <tbody id="drivers-tbody">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Customers Section -->
        <div id="customers" class="section">
          <div class="table-container">
            <div class="table-header">
              <h3>üë• Danh s√°ch kh√°ch h√†ng</h3>
              <input type="text" class="search-box" placeholder="üîç T√¨m kh√°ch h√†ng..." onkeyup="searchCustomers(this.value)">
            </div>
            <table>
              <thead>
                <tr>
                  <th>Kh√°ch h√†ng</th>
                  <th>SƒêT</th>
                  <th>Lo·∫°i</th>
                  <th>T·ªïng ƒë∆°n</th>
                  <th>Doanh thu</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody id="customers-tbody">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Reports Section -->
        <div id="reports" class="section">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue">üìÖ</div>
              <div class="stat-info">
                <h3 id="report-daily-orders">0</h3>
                <p>ƒê∆°n h√¥m nay</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon green">üìÜ</div>
              <div class="stat-info">
                <h3 id="report-monthly-orders">0</h3>
                <p>ƒê∆°n th√°ng n√†y</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon orange">üíµ</div>
              <div class="stat-info">
                <h3 id="report-daily-revenue">0‚Ç´</h3>
                <p>Doanh thu h√¥m nay</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon red">üí∞</div>
              <div class="stat-info">
                <h3 id="report-monthly-revenue">0‚Ç´</h3>
                <p>Doanh thu th√°ng</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Order Modal -->
  <div id="create-order-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>T·∫°o ƒë∆°n h√†ng m·ªõi</h3>
        <button class="close-btn" onclick="closeModal('create-order')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Kh√°ch h√†ng</label>
          <select id="order-customer">
            <option value="">Ch·ªçn kh√°ch h√†ng...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ng∆∞·ªùi g·ª≠i</label>
          <input type="text" id="order-sender" placeholder="T√™n ng∆∞·ªùi g·ª≠i">
        </div>
        <div class="form-group">
          <label>SƒêT ng∆∞·ªùi g·ª≠i</label>
          <input type="text" id="order-sender-phone" placeholder="0901234567">
        </div>
        <div class="form-group">
          <label>ƒê·ªãa ch·ªâ g·ª≠i</label>
          <textarea id="order-from"></textarea>
        </div>
        <div class="form-group">
          <label>Ng∆∞·ªùi nh·∫≠n</label>
          <input type="text" id="order-receiver" placeholder="T√™n ng∆∞·ªùi nh·∫≠n">
        </div>
        <div class="form-group">
          <label>SƒêT ng∆∞·ªùi nh·∫≠n</label>
          <input type="text" id="order-receiver-phone" placeholder="0907654321">
        </div>
        <div class="form-group">
          <label>ƒê·ªãa ch·ªâ nh·∫≠n</label>
          <textarea id="order-to"></textarea>
        </div>
        <div class="form-group">
          <label>Lo·∫°i h√†ng</label>
          <select id="order-type">
            <option value="other">Kh√°c</option>
            <option value="fragile">D·ªÖ v·ª°</option>
            <option value="electronics">ƒêi·ªán t·ª≠</option>
            <option value="food">Th·ª±c ph·∫©m</option>
            <option value="cold">H√†ng l·∫°nh</option>
            <option value="document">T√†i li·ªáu</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tr·ªçng l∆∞·ª£ng (kg)</label>
          <input type="number" id="order-weight" placeholder="0.5" step="0.1">
        </div>
        <div class="form-group">
          <label>Gi√° tr·ªã h√†ng (VNƒê)</label>
          <input type="number" id="order-value" placeholder="500000">
        </div>
        <div class="form-group">
          <label>Ph√≠ ship (VNƒê)</label>
          <input type="number" id="order-fee" placeholder="50000">
        </div>
        <div class="form-group">
          <label>Thu h·ªô COD (VNƒê)</label>
          <input type="number" id="order-cod" placeholder="0">
        </div>
        <div class="form-group">
          <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
          <select id="order-payment">
            <option value="cash">Ti·ªÅn m·∫∑t</option>
            <option value="bank_transfer">Chuy·ªÉn kho·∫£n</option>
            <option value="e_wallet">V√≠ ƒëi·ªán t·ª≠</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal('create-order')" style="background:#6c757d;color:white">H·ªßy</button>
        <button class="btn btn-primary" onclick="createOrder()">T·∫°o ƒë∆°n</button>
      </div>
    </div>
  </div>

  <script>
    // API Configuration
    const API_BASE = '/api'; // ƒêi·ªÅu ch·ªânh theo c·∫•u h√¨nh server c·ªßa b·∫°n
    let authToken = localStorage.getItem('authToken') || '';

    // API Helper
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': authToken ? `Bearer ${authToken}` : '',
            ...options.headers
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error('API call failed:', error);
        throw error;
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      loadDashboard();
      loadOrders();
      loadVehicles();
      loadDrivers();
      loadCustomers();
    });

    // Navigation
    function showSection(sectionId) {
      document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
      event.target.closest('.nav-item').classList.add('active');
      
      document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      
      const titles = {
        dashboard: 'Dashboard',
        orders: 'Qu·∫£n l√Ω ƒë∆°n h√†ng',
        vehicles: 'Qu·∫£n l√Ω xe',
        drivers: 'Qu·∫£n l√Ω t√†i x·∫ø',
        customers: 'Qu·∫£n l√Ω kh√°ch h√†ng',
        reports: 'B√°o c√°o'
      };
      document.getElementById('page-title').textContent = titles[sectionId] || 'Dashboard';

      // Load data when switching tabs
      if (sectionId === 'dashboard') loadDashboard();
      if (sectionId === 'orders') loadOrders();
      if (sectionId === 'vehicles') loadVehicles();
      if (sectionId === 'drivers') loadDrivers();
      if (sectionId === 'customers') loadCustomers();
    }

    // Modal functions
    function showModal(modalName) {
      document.getElementById(modalName + '-modal').classList.add('active');
      if (modalName === 'create-order') {
        loadCustomerSelect();
      }
    }

    function closeModal(modalName) {
      document.getElementById(modalName + '-modal').classList.remove('active');
    }

    // Initialize Map
    let map;
    function initMap() {
      map = L.map('map').setView([10.776530, 106.700981], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
    }

    // Load Dashboard
    async function loadDashboard() {
      try {
        const data = await apiCall('/dashboard/admin');
        
        document.getElementById('stat-total-orders').textContent = data.total_orders || 0;
        document.getElementById('stat-delivered').textContent = data.delivered_orders || 0;
        document.getElementById('stat-vehicles').textContent = data.active_vehicles || 0;
        document.getElementById('stat-revenue').textContent = formatMoney(data.today_revenue || 0);

        // Load overload alerts
        await loadOverloadAlerts();
      } catch (error) {
        console.error('Failed to load dashboard:', error);
      }
    }

    // Load overloaded vehicles
    async function loadOverloadAlerts() {
      try {
        const vehicles = await apiCall('/vehicles/overloaded');
        const alertsDiv = document.getElementById('overload-alerts');
        
        if (vehicles && vehicles.length > 0) {
          alertsDiv.innerHTML = vehicles.map(v => `
            <div class="alert-banner alert-warning">
              <span class="alert-icon">‚ö†Ô∏è</span>
              <div style="flex:1">
                <strong>Xe ${v.license_plate} ƒë√£ t·∫£i ${v.capacity_percentage}%</strong> (${v.current_weight}/${v.max_weight}kg)
                <div class="progress-bar">
                  <div class="progress-fill" style="width: ${v.capacity_percentage}%; background: ${v.capacity_percentage >= 100 ? 'var(--danger)' : 'var(--warning)'}"></div>
                </div>
              </div>
              <button class="btn btn-primary" onclick="viewVehicle(${v.id})">Chi ti·∫øt</button>
            </div>
          `).join('');
        } else {
          alertsDiv.innerHTML = '<p style="text-align:center;color:#7f8c8d;">‚úÖ T·∫•t c·∫£ xe ƒëang ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng</p>';
        }
      } catch (error) {
        document.getElementById('overload-alerts').innerHTML = '<p style="text-align:center;color:#7f8c8d;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</p>';
      }
    }

    // Load Orders
    async function loadOrders() {
      try {
        const response = await apiCall('/orders?page=1&pageSize=50');
        const orders = response.data || [];
        
        const tbody = document.getElementById('orders-tbody');
        if (orders.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#7f8c8d;padding:40px">Ch∆∞a c√≥ ƒë∆°n h√†ng</td></tr>';
          return;
        }

        tbody.innerHTML = orders.map(o => `
          <tr>
            <td><strong>${o.tracking_code}</strong></td>
            <td>${o.customer_name || 'N/A'}</td>
            <td>${truncate(o.sender_address, 15)} ‚Üí ${truncate(o.receiver_address, 15)}</td>
            <td><span class="badge ${getStatusBadge(o.order_status)}">${getStatusText(o.order_status)}</span></td>
            <td>${o.vehicle_license_plate || '-'}</td>
            <td>${formatMoney(o.shipping_fee)}</td>
            <td>${formatMoney(o.cod_amount)}</td>
            <td><span class="badge ${o.payment_status === 'paid' ? 'badge-success' : 'badge-warning'}">${o.payment_status === 'paid' ? 'ƒê√£ TT' : 'Ch∆∞a TT'}</span></td>
            <td>
              <button class="btn btn-primary" style="padding:5px 10px;font-size:12px" onclick="viewOrder(${o.id})">Chi ti·∫øt</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load orders:', error);
        document.getElementById('orders-tbody').innerHTML = '<tr><td colspan="9" style="text-align:center;color:#d9534f;padding:40px">Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng</td></tr>';
      }
    }

    // Load Vehicles
    async function loadVehicles() {
      try {
        const response = await apiCall('/vehicles?page=1&pageSize=50');
        const vehicles = response.data || [];
        
        const tbody = document.getElementById('vehicles-tbody');
        if (vehicles.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#7f8c8d;padding:40px">Ch∆∞a c√≥ xe</td></tr>';
          return;
        }

        tbody.innerHTML = vehicles.map(v => `
          <tr>
            <td><strong>${v.license_plate}</strong></td>
            <td>${getVehicleType(v.vehicle_type)}</td>
            <td>${v.max_weight}kg</td>
            <td>${v.current_weight}kg</td>
            <td>
              <strong style="color: ${v.capacity_percentage >= 95 ? 'var(--danger)' : v.capacity_percentage >= 70 ? 'var(--warning)' : 'var(--success)'}">
                ${v.capacity_percentage}%
              </strong>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${v.capacity_percentage}%; background: ${v.capacity_percentage >= 95 ? 'var(--danger)' : 'var(--success)'}"></div>
              </div>
            </td>
            <td><span class="badge ${getVehicleStatusBadge(v.vehicle_status)}">${getVehicleStatusText(v.vehicle_status)}</span></td>
            <td>
              <button class="btn btn-primary" style="padding:5px 10px;font-size:12px" onclick="viewVehicle(${v.id})">Chi ti·∫øt</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load vehicles:', error);
        document.getElementById('vehicles-tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:#d9534f;padding:40px">Kh√¥ng th·ªÉ t·∫£i danh s√°ch xe</td></tr>';
      }
    }

    // Load Drivers
    async function loadDrivers() {
      try {
        const response = await apiCall('/drivers?page=1&pageSize=50');
        const drivers = response.data || [];
        
        const tbody = document.getElementById('drivers-tbody');
        if (drivers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#7f8c8d;padding:40px">Ch∆∞a c√≥ t√†i x·∫ø</td></tr>';
          return;
        }

        tbody.innerHTML = drivers.map(d => `
          <tr>
            <td><strong>${d.full_name}</strong></td>
            <td>${d.phone_number}</td>
            <td>${d.license_number || 'N/A'}</td>
            <td>${d.total_trips || 0}</td>
            <td>‚≠ê ${d.average_rating ? d.average_rating.toFixed(1) : 'N/A'}</td>
            <td><span class="badge ${d.is_active ? 'badge-success' : 'badge-danger'}">${d.is_active ? 'Ho·∫°t ƒë·ªông' : 'Ngh·ªâ'}</span></td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load drivers:', error);
        document.getElementById('drivers-tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#d9534f;padding:40px">Kh√¥ng th·ªÉ t·∫£i danh s√°ch t√†i x·∫ø</td></tr>';
      }
    }

    // Load Customers
    async function loadCustomers() {
      try {
        const response = await apiCall('/customers?page=1&pageSize=50');
        const customers = response.data || [];
        
        const tbody = document.getElementById('customers-tbody');
        if (customers.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#7f8c8d;padding:40px">Ch∆∞a c√≥ kh√°ch h√†ng</td></tr>';
          return;
        }

        tbody.innerHTML = customers.map(c => `
          <tr>
            <td><strong>${c.customer_name}</strong></td>
            <td>${c.phone_number}</td>
            <td><span class="badge ${c.is_regular_customer ? 'badge-success' : 'badge-info'}">${c.is_regular_customer ? '‚≠ê Kh√°ch quen' : 'Kh√°ch m·ªõi'}</span></td>
            <td>${c.total_orders || 0}</td>
            <td>${formatMoney(c.total_revenue || 0)}</td>
            <td>
              <button class="btn btn-primary" style="padding:5px 10px;font-size:12px" onclick="viewCustomer(${c.id})">Chi ti·∫øt</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Failed to load customers:', error);
        document.getElementById('customers-tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#d9534f;padding:40px">Kh√¥ng th·ªÉ t·∫£i danh s√°ch kh√°ch h√†ng</td></tr>';
      }
    }

    // Load customer select for create order
    async function loadCustomerSelect() {
      try {
        const response = await apiCall('/customers?page=1&pageSize=100');
        const customers = response.data || [];
        
        const select = document.getElementById('order-customer');
        select.innerHTML = '<option value="">Ch·ªçn kh√°ch h√†ng...</option>' + 
          customers.map(c => `<option value="${c.id}">${c.customer_name} - ${c.phone_number}</option>`).join('');
      } catch (error) {
        console.error('Failed to load customers:', error);
      }
    }

    // Create Order
    async function createOrder() {
      const data = {
        customer_id: parseInt(document.getElementById('order-customer').value) || null,
        sender_name: document.getElementById('order-sender').value,
        sender_phone: document.getElementById('order-sender-phone').value,
        sender_address: document.getElementById('order-from').value,
        receiver_name: document.getElementById('order-receiver').value,
        receiver_phone: document.getElementById('order-receiver-phone').value,
        receiver_address: document.getElementById('order-to').value,
        parcel_type: document.getElementById('order-type').value,
        weight_kg: parseFloat(document.getElementById('order-weight').value) || 0,
        declared_value: parseInt(document.getElementById('order-value').value) || 0,
        shipping_fee: parseInt(document.getElementById('order-fee').value) || 0,
        cod_amount: parseInt(document.getElementById('order-cod').value) || 0,
        payment_method: document.getElementById('order-payment').value
      };

      if (!data.sender_name || !data.receiver_name || !data.sender_address || !data.receiver_address) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
      }

      try {
        const result = await apiCall('/orders', {
          method: 'POST',
          body: JSON.stringify(data)
        });

        closeModal('create-order');
        alert('‚úÖ ƒê√£ t·∫°o ƒë∆°n h√†ng th√†nh c√¥ng: ' + result.tracking_code);
        loadOrders();
        loadDashboard();
      } catch (error) {
        alert('‚ùå L·ªói khi t·∫°o ƒë∆°n h√†ng: ' + error.message);
      }
    }

    // Search orders
    function searchOrders(keyword) {
      const rows = document.querySelectorAll('#orders-tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(keyword.toLowerCase()) ? '' : 'none';
      });
    }

    // Search customers
    function searchCustomers(keyword) {
      const rows = document.querySelectorAll('#customers-tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(keyword.toLowerCase()) ? '' : 'none';
      });
    }

    // Helper functions
    function formatMoney(amount) {
      return new Intl.NumberFormat('vi-VN', {style: 'currency', currency: 'VND'}).format(amount);
    }

    function truncate(str, length) {
      if (!str) return '';
      return str.length > length ? str.substring(0, length) + '...' : str;
    }

    function getStatusText(status) {
      const map = {
        pending_pickup: 'Ch·ªù l·∫•y',
        pickup_confirmed: 'ƒê√£ l·∫•y',
        in_transit: 'ƒêang giao',
        out_for_delivery: 'ƒêang giao',
        delivered: 'ƒê√£ giao',
        returned: 'Ho√†n h√†ng',
        cancelled: 'ƒê√£ h·ªßy'
      };
      return map[status] || status;
    }

    function getStatusBadge(status) {
      const map = {
        pending_pickup: 'badge-warning',
        pickup_confirmed: 'badge-info',
        in_transit: 'badge-info',
        out_for_delivery: 'badge-info',
        delivered: 'badge-success',
        returned: 'badge-danger',
        cancelled: 'badge-danger'
      };
      return map[status] || 'badge-info';
    }

    function getVehicleType(type) {
      const map = {truck: 'üöõ T·∫£i', van: 'üöê Van', motorbike: 'üõµ Xe m√°y'};
      return map[type] || type;
    }

    function getVehicleStatusText(status) {
      const map = {
        available: 'S·∫µn s√†ng',
        in_transit: 'ƒêang ch·∫°y',
        maintenance: 'B·∫£o d∆∞·ª°ng',
        inactive: 'Ng∆∞ng',
        overloaded: 'Qu√° t·∫£i'
      };
      return map[status] || status;
    }

    function getVehicleStatusBadge(status) {
      const map = {
        available: 'badge-success',
        in_transit: 'badge-info',
        maintenance: 'badge-warning',
        inactive: 'badge-danger',
        overloaded: 'badge-danger'
      };
      return map[status] || 'badge-info';
    }

    function viewOrder(id) {
      alert('Xem chi ti·∫øt ƒë∆°n h√†ng #' + id);
      // Implement view order detail
    }

    function viewVehicle(id) {
      alert('Xem chi ti·∫øt xe #' + id);
      // Implement view vehicle detail
    }

    function viewCustomer(id) {
      alert('Xem chi ti·∫øt kh√°ch h√†ng #' + id);
      // Implement view customer detail
    }
  </script>
</body>
</html>
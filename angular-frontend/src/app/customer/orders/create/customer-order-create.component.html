<div class="order-create-wizard">
    <!-- Success Screen -->
    @if (orderCreated()) {
    <div class="success-screen">
        <div class="success-icon">‚úÖ</div>
        <h1>ƒê√£ t·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!</h1>
        <p>ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn h·ªá th·ªëng x·ª≠ l√Ω. B·∫°n c√≥ th·ªÉ theo d√µi tr·∫°ng th√°i ngay b√¢y gi·ªù.</p>

        <div class="success-info">
            <div class="tracking-code-card">
                <span class="label">üè∑Ô∏è M√É V·∫¨N ƒê∆†N</span>
                <span class="code">{{ createdOrderCode }}</span>
            </div>
            <div class="qr-card">
                <span class="label">üì± Qu√©t m√£ QR</span>
                <p>S·ª≠ d·ª•ng ·ª©ng d·ª•ng mobile ƒë·ªÉ qu√©t v√† theo d√µi nhanh ch√≥ng.</p>
            </div>
        </div>

        <div class="success-actions">
            <button class="btn-primary" (click)="createNewOrder()">‚ûï T·∫°o ƒë∆°n m·ªõi</button>
            <button class="btn-secondary" (click)="trackOrder()">üìç Theo d√µi ƒë∆°n</button>
        </div>

        <a class="back-link" (click)="goHome()">‚Üê V·ªÅ trang ch·ªß</a>
    </div>
    } @else {

    <!-- Step Indicator -->
    <div class="step-indicator">
        @for (step of steps; track step.number) {
        <div class="step-item" [class.active]="currentStep() === step.number"
            [class.completed]="currentStep() > step.number" (click)="goToStep(step.number)">
            <div class="step-number">
                @if (currentStep() > step.number) {
                <span class="check">‚úì</span>
                } @else {
                {{ step.number }}
                }
            </div>
            <span class="step-label">{{ step.label }}</span>
        </div>
        @if (step.number < totalSteps) { <div class="step-line" [class.completed]="currentStep() > step.number">
    </div>
    }
    }
</div>

<!-- Form Container -->
<div class="form-container">

    <!-- Step 1: Ch·ªçn tuy·∫øn ƒë∆∞·ªùng -->
    @if (currentStep() === 1) {
    <div class="form-step">
        <div class="form-header">
            <h2>üöö Ch·ªçn tuy·∫øn ƒë∆∞·ªùng</h2>
            <p>Ch·ªçn tuy·∫øn ƒë∆∞·ªùng ph√π h·ª£p v·ªõi n∆°i g·ª≠i v√† n∆°i nh·∫≠n c·ªßa b·∫°n.</p>
        </div>

        <div class="form-content">
            <!-- Search -->
            <div class="form-group">
                <div class="input-with-icon">
                    <span class="icon">üîç</span>
                    <input type="text" [(ngModel)]="searchTerm" (input)="filterRoutes()"
                        placeholder="T√¨m tuy·∫øn ƒë∆∞·ªùng, nh√† xe, t·ªânh th√†nh...">
                </div>
            </div>

            <!-- Loading -->
            @if (loadingRoutes()) {
            <div class="loading-routes">
                <span class="spinner"></span> ƒêang t·∫£i danh s√°ch tuy·∫øn ƒë∆∞·ªùng...
            </div>
            } @else if (filteredRoutes.length === 0) {
            <div class="no-routes">
                <span class="icon">üö´</span>
                <p>Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng n√†o. Vui l√≤ng th·ª≠ l·∫°i v·ªõi t·ª´ kh√≥a kh√°c.</p>
            </div>
            } @else {
            <!-- Routes List -->
            <div class="routes-grid">
                @for (route of filteredRoutes; track route.routeId) {
                <div class="route-card" [class.selected]="selectedRoute?.routeId === route.routeId"
                    (click)="selectRoute(route)">
                    <div class="route-header">
                        <span class="route-name">{{ route.routeName }}</span>
                        @if (selectedRoute?.routeId === route.routeId) {
                        <span class="selected-badge">‚úì</span>
                        }
                    </div>
                    <div class="route-company">
                        <span class="company-icon">üè¢</span>
                        <span class="company-name">{{ route.companyName }}</span>
                    </div>
                    <div class="route-details">
                        <div class="route-info">
                            <span class="info-icon">üìç</span>
                            <span>{{ route.originProvince }} ‚Üí {{ route.destinationProvince }}</span>
                        </div>
                        @if (route.distanceKm) {
                        <div class="route-info">
                            <span class="info-icon">üìè</span>
                            <span>{{ route.distanceKm }} km</span>
                        </div>
                        }
                        @if (route.estimatedDurationHours) {
                        <div class="route-info">
                            <span class="info-icon">‚è±Ô∏è</span>
                            <span>~{{ route.estimatedDurationHours }}h</span>
                        </div>
                        }
                    </div>
                    <div class="route-price">
                        <span class="price">{{ formatCurrency(route.basePrice) }}</span>
                        <span class="price-label">Gi√° c∆∞·ªõc c∆° b·∫£n</span>
                    </div>
                </div>
                }
            </div>
            }

            <!-- Selected Route Summary -->
            @if (selectedRoute) {
            <div class="selected-route-summary">
                <h4>üì¶ Tuy·∫øn ƒë∆∞·ªùng ƒë√£ ch·ªçn</h4>
                <div class="summary-content">
                    <div class="summary-item">
                        <span class="label">Tuy·∫øn</span>
                        <span class="value">{{ selectedRoute.routeName }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Nh√† xe</span>
                        <span class="value">{{ selectedRoute.companyName }}</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">Gi√° c∆∞·ªõc</span>
                        <span class="value highlight">{{ formatCurrency(selectedRoute.basePrice) }}</span>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
    }

    <!-- Step 2: Sender Info -->
    @if (currentStep() === 2) {
    <div class="form-step">
        <div class="form-header">
            <h2>üë§ Th√¥ng tin ng∆∞·ªùi g·ª≠i</h2>
            <p>Nh·∫≠p th√¥ng tin ng∆∞·ªùi g·ª≠i. ƒê·ªãa ch·ªâ g·ª≠i d·ª±a tr√™n tuy·∫øn: <strong>{{ selectedRoute?.originProvince
                    }}</strong></p>
        </div>

        <form [formGroup]="senderForm" class="form-content">
            <div class="form-row">
                <div class="form-group">
                    <label>H·ªç v√† t√™n <span class="required">*</span></label>
                    <div class="input-with-icon">
                        <span class="icon">üë§</span>
                        <input type="text" formControlName="senderName" placeholder="Nh·∫≠p h·ªç t√™n ƒë·∫ßy ƒë·ªß">
                    </div>
                </div>
                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                    <div class="input-with-icon">
                        <span class="icon">üìû</span>
                        <input type="tel" formControlName="senderPhone" placeholder="090 123 4567">
                    </div>
                    @if (senderForm.get('senderPhone')?.touched && senderForm.get('senderPhone')?.invalid) {
                    <span class="error">S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá</span>
                    }
                </div>
            </div>

            <div class="form-group">
                <label>ƒê·ªãa ch·ªâ chi ti·∫øt <span class="required">*</span></label>
                <div class="input-with-icon">
                    <span class="icon">üìç</span>
                    <input type="text" formControlName="senderAddress"
                        placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, t√≤a nh√†, khu d√¢n c∆∞...">
                </div>
                <span class="hint">ƒê·ªãa ch·ªâ thu·ªôc: {{ selectedRoute?.originDistrict }}, {{ selectedRoute?.originProvince
                    }}</span>
            </div>

            <label class="checkbox-label">
                <input type="checkbox" formControlName="saveToAddressBook">
                <span>L∆∞u ƒë·ªãa ch·ªâ n√†y v√†o danh b·∫° ng∆∞·ªùi g·ª≠i</span>
            </label>
        </form>
    </div>
    }

    <!-- Step 3: Receiver Info -->
    @if (currentStep() === 3) {
    <div class="form-step">
        <div class="form-header">
            <h2>üì¶ Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h2>
            <p>Nh·∫≠p th√¥ng tin ng∆∞·ªùi nh·∫≠n h√†ng. ƒê·ªãa ch·ªâ nh·∫≠n: <strong>{{ selectedRoute?.destinationProvince }}</strong>
            </p>
        </div>

        <form [formGroup]="receiverForm" class="form-content">
            <div class="form-row">
                <div class="form-group">
                    <label>H·ªç v√† t√™n <span class="required">*</span></label>
                    <div class="input-with-icon">
                        <span class="icon">üë§</span>
                        <input type="text" formControlName="receiverName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n">
                    </div>
                </div>
                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
                    <div class="input-with-icon">
                        <span class="icon">üìû</span>
                        <input type="tel" formControlName="receiverPhone" placeholder="0912 345 678">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>ƒê·ªãa ch·ªâ chi ti·∫øt <span class="required">*</span></label>
                <div class="input-with-icon">
                    <span class="icon">üìç</span>
                    <input type="text" formControlName="receiverAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß...">
                </div>
                <span class="hint">ƒê·ªãa ch·ªâ thu·ªôc: {{ selectedRoute?.destinationDistrict }}, {{
                    selectedRoute?.destinationProvince }}</span>
            </div>

            <div class="form-group">
                <label>Ghi ch√∫ cho shipper</label>
                <textarea formControlName="courierNote"
                    placeholder="V√≠ d·ª•: G·ªçi tr∆∞·ªõc khi giao, Ch·ªâ giao gi·ªù h√†nh ch√≠nh..."></textarea>
            </div>

            <label class="checkbox-label">
                <input type="checkbox" formControlName="saveToAddressBook">
                <span>L∆∞u v√†o danh b·∫° ng∆∞·ªùi nh·∫≠n</span>
            </label>
        </form>
    </div>
    }

    <!-- Step 4: Goods Info -->
    @if (currentStep() === 4) {
    <div class="form-step">
        <div class="form-header">
            <h2>üìã Th√¥ng tin h√†ng h√≥a</h2>
            <p>Nh·∫≠p th√¥ng tin v·ªÅ ki·ªán h√†ng c·∫ßn g·ª≠i.</p>
        </div>

        <form [formGroup]="goodsForm" class="form-content">
            <div class="form-group">
                <label>Lo·∫°i h√†ng h√≥a <span class="required">*</span></label>
                <div class="parcel-types">
                    @for (type of parcelTypes; track type.value) {
                    <label class="parcel-type-option"
                        [class.selected]="goodsForm.get('parcelType')?.value === type.value">
                        <input type="radio" formControlName="parcelType" [value]="type.value">
                        <span class="icon">{{ type.icon }}</span>
                        <span class="label">{{ type.label }}</span>
                    </label>
                    }
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Kh·ªëi l∆∞·ª£ng (kg) <span class="required">*</span></label>
                    <div class="input-with-addon">
                        <input type="number" formControlName="weightKg" min="0.1" max="100" step="0.1"
                            (change)="calculateShippingFee()">
                        <span class="addon">kg</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Gi√° tr·ªã khai b√°o</label>
                    <div class="input-with-addon">
                        <input type="number" formControlName="declaredValue" min="0">
                        <span class="addon">VNƒê</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Y√™u c·∫ßu ƒë·∫∑c bi·ªát</label>
                <textarea formControlName="specialInstructions"
                    placeholder="V√≠ d·ª•: H√†ng d·ªÖ v·ª°, c·∫ßn ƒë√≥ng g√≥i c·∫©n th·∫≠n..."></textarea>
            </div>
        </form>
    </div>
    }

    <!-- Step 5: Payment & Confirm -->
    @if (currentStep() === 5) {
    <div class="form-step">
        <div class="form-header">
            <h2>üí≥ Thanh to√°n & X√°c nh·∫≠n</h2>
            <p>Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n v√† x√°c nh·∫≠n ƒë∆°n h√†ng.</p>
        </div>

        <form [formGroup]="paymentForm" class="form-content">
            <div class="form-group">
                <label>Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                <div class="payment-methods">
                    @for (method of paymentMethods; track method.value) {
                    <label class="payment-method-option"
                        [class.selected]="paymentForm.get('paymentMethod')?.value === method.value">
                        <input type="radio" formControlName="paymentMethod" [value]="method.value">
                        <span class="icon">{{ method.icon }}</span>
                        <span class="label">{{ method.label }}</span>
                    </label>
                    }
                </div>
            </div>

            <div class="form-group">
                <label>Ti·ªÅn thu h·ªô (COD)</label>
                <div class="input-with-addon">
                    <input type="number" formControlName="codAmount" min="0" placeholder="0">
                    <span class="addon">VNƒê</span>
                </div>
                <span class="hint">ƒê·ªÉ tr·ªëng ho·∫∑c nh·∫≠p 0 n·∫øu kh√¥ng thu h·ªô</span>
            </div>
        </form>

        <!-- Order Summary -->
        <div class="confirm-content">
            <div class="confirm-section">
                <h3>üöö Tuy·∫øn ƒë∆∞·ªùng</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Tuy·∫øn</span>
                        <span class="value">{{ selectedRoute?.routeName }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Nh√† xe</span>
                        <span class="value">{{ selectedRoute?.companyName }}</span>
                    </div>
                </div>
            </div>

            <div class="confirm-section">
                <h3>üë§ Ng∆∞·ªùi g·ª≠i</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">H·ªç t√™n</span>
                        <span class="value">{{ senderForm.value.senderName }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">S·ªë ƒëi·ªán tho·∫°i</span>
                        <span class="value">{{ senderForm.value.senderPhone }}</span>
                    </div>
                    <div class="info-item full">
                        <span class="label">ƒê·ªãa ch·ªâ</span>
                        <span class="value">{{ senderForm.value.senderAddress }}, {{ selectedRoute?.originDistrict }},
                            {{ selectedRoute?.originProvince }}</span>
                    </div>
                </div>
            </div>

            <div class="confirm-section">
                <h3>üì¶ Ng∆∞·ªùi nh·∫≠n</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">H·ªç t√™n</span>
                        <span class="value">{{ receiverForm.value.receiverName }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">S·ªë ƒëi·ªán tho·∫°i</span>
                        <span class="value">{{ receiverForm.value.receiverPhone }}</span>
                    </div>
                    <div class="info-item full">
                        <span class="label">ƒê·ªãa ch·ªâ</span>
                        <span class="value">{{ receiverForm.value.receiverAddress }}, {{
                            selectedRoute?.destinationDistrict }}, {{ selectedRoute?.destinationProvince }}</span>
                    </div>
                </div>
            </div>

            <div class="confirm-section">
                <h3>üìã H√†ng h√≥a</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Lo·∫°i h√†ng</span>
                        <span class="value">{{ getParcelTypeLabel(goodsForm.value.parcelType) }}</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Kh·ªëi l∆∞·ª£ng</span>
                        <span class="value">{{ goodsForm.value.weightKg }} kg</span>
                    </div>
                </div>
            </div>

            <div class="fee-summary">
                <div class="fee-row">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                    <span class="amount">{{ formatCurrency(shippingFee()) }}</span>
                </div>
                @if (paymentForm.get('codAmount')?.value > 0) {
                <div class="fee-row">
                    <span>Ti·ªÅn thu h·ªô</span>
                    <span class="amount">{{ formatCurrency(paymentForm.get('codAmount')?.value) }}</span>
                </div>
                }
                <div class="fee-row total">
                    <span>T·ªïng thanh to√°n</span>
                    <span class="amount">{{ formatCurrency(shippingFee()) }}</span>
                </div>
            </div>
        </div>
    </div>
    }
</div>

<!-- Navigation Buttons -->
<div class="form-actions">
    @if (currentStep() > 1) {
    <button class="btn-secondary" (click)="prevStep()">‚Üê Quay l·∫°i</button>
    } @else {
    <button class="btn-secondary" routerLink="/customer">H·ªßy b·ªè</button>
    }

    @if (currentStep() < totalSteps) { <button class="btn-primary" (click)="nextStep()"
        [disabled]="!isStepValid(currentStep())">
        Ti·∫øp t·ª•c ‚Üí
        </button>
        } @else {
        <button class="btn-primary submit" (click)="submitOrder()" [disabled]="isSubmitting()">
            @if (isSubmitting()) {
            <span class="spinner"></span> ƒêang x·ª≠ l√Ω...
            } @else {
            ‚úÖ T·∫°o ƒë∆°n h√†ng
            }
        </button>
        }
</div>
}
</div>
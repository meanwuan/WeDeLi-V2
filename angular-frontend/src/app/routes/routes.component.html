<div class="routes-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-left">
            <div class="breadcrumb">
                <a routerLink="/dashboard">Dashboard</a>
                <span>/</span>
                <span class="current">Tuy·∫øn ƒë∆∞·ªùng</span>
            </div>
            <h1>Qu·∫£n l√Ω Tuy·∫øn ƒë∆∞·ªùng</h1>
        </div>
        <button class="btn btn-primary" (click)="openCreateModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Th√™m tuy·∫øn m·ªõi
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon blue">üõ§Ô∏è</div>
            <div class="stat-content">
                <span class="stat-value">{{ stats().totalRoutes }}</span>
                <span class="stat-label">T·ªïng tuy·∫øn ƒë∆∞·ªùng</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon green">‚úÖ</div>
            <div class="stat-content">
                <span class="stat-value">{{ stats().activeRoutes }}</span>
                <span class="stat-label">Tuy·∫øn ƒëang ho·∫°t ƒë·ªông</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon orange">üí∞</div>
            <div class="stat-content">
                <span class="stat-value">{{ formatCurrency(stats().averagePrice) }}</span>
                <span class="stat-label">Gi√° trung b√¨nh</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">üìà</div>
            <div class="stat-content">
                <span class="stat-value">+{{ stats().newThisMonth }}</span>
                <span class="stat-label">Tuy·∫øn m·ªõi trong th√°ng</span>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <label>T·ªânh ƒëi</label>
            <select [(ngModel)]="filterOrigin">
                <option value="">T·∫•t c·∫£ t·ªânh ƒëi</option>
                @for (province of provinces; track province) {
                <option [value]="province">{{ province }}</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>T·ªânh ƒë·∫øn</label>
            <select [(ngModel)]="filterDestination">
                <option value="">T·∫•t c·∫£ t·ªânh ƒë·∫øn</option>
                @for (province of provinces; track province) {
                <option [value]="province">{{ province }}</option>
                }
            </select>
        </div>
        <div class="filter-toggle">
            <label class="toggle-label">
                <input type="checkbox" [(ngModel)]="filterActiveOnly" />
                <span class="toggle-slider"></span>
                Ch·ªâ hi·ªán tuy·∫øn ho·∫°t ƒë·ªông
            </label>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary btn-sm" (click)="loadRoutes()">L·ªçc</button>
            <button class="btn btn-secondary btn-sm" (click)="clearFilters()">X√≥a</button>
        </div>
    </div>

    <!-- Routes Table -->
    <div class="table-container">
        @if (loading()) {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
        } @else if (filteredRoutes.length === 0) {
        <div class="empty-state">
            <div class="empty-icon">üõ§Ô∏è</div>
            <h3>Ch∆∞a c√≥ tuy·∫øn ƒë∆∞·ªùng n√†o</h3>
            <p>Th√™m tuy·∫øn ƒë∆∞·ªùng ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
            <button class="btn btn-primary" (click)="openCreateModal()">Th√™m tuy·∫øn ƒë·∫ßu ti√™n</button>
        </div>
        } @else {
        <table class="routes-table">
            <thead>
                <tr>
                    <th>T√™n tuy·∫øn</th>
                    <th>ƒêi·ªÉm ƒëi</th>
                    <th>ƒêi·ªÉm ƒë·∫øn</th>
                    <th>Kho·∫£ng c√°ch</th>
                    <th>Th·ªùi gian ∆∞·ªõc t√≠nh</th>
                    <th>Gi√° c∆∞·ªõc c∆° b·∫£n</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                @for (route of filteredRoutes; track route.routeId) {
                <tr>
                    <td>
                        <div class="route-name">
                            <strong>{{ route.routeName }}</strong>
                            <span class="route-id">ID: RT-{{ route.routeId }}</span>
                        </div>
                    </td>
                    <td>
                        <div class="location">
                            <span class="province">{{ route.originProvince }}</span>
                            @if (route.originDistrict) {
                            <span class="district">{{ route.originDistrict }}</span>
                            }
                        </div>
                    </td>
                    <td>
                        <div class="location">
                            <span class="province">{{ route.destinationProvince }}</span>
                            @if (route.destinationDistrict) {
                            <span class="district">{{ route.destinationDistrict }}</span>
                            }
                        </div>
                    </td>
                    <td>{{ route.distanceKm ? route.distanceKm + ' km' : '-' }}</td>
                    <td>{{ route.estimatedDurationHours ? route.estimatedDurationHours + ' gi·ªù' : '-' }}</td>
                    <td class="price">{{ formatCurrency(route.basePrice) }}</td>
                    <td>
                        <span class="status-badge" [class.active]="route.isActive" [class.inactive]="!route.isActive">
                            {{ route.isActive ? 'ƒêang ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng' }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" title="S·ª≠a" (click)="openEditModal(route)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="action-btn delete" title="X√≥a" (click)="openDeleteModal(route)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                            <button class="action-btn toggle" [class.active]="route.isActive" title="B·∫≠t/T·∫Øt"
                                (click)="toggleStatus(route)">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    @if (route.isActive) {
                                    <line x1="15" y1="9" x2="9" y2="15"></line>
                                    <line x1="9" y1="9" x2="15" y2="15"></line>
                                    } @else {
                                    <polyline points="9 11 12 14 22 4"></polyline>
                                    }
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                }
            </tbody>
        </table>

        <!-- Pagination -->
        @if (totalPages > 1) {
        <div class="pagination">
            <span class="pagination-info">Hi·ªÉn th·ªã {{ (currentPage - 1) * pageSize + 1 }}-{{ currentPage * pageSize >
                totalItems ? totalItems : currentPage * pageSize }} trong s·ªë {{ totalItems }} tuy·∫øn</span>
            <div class="pagination-controls">
                <button class="page-btn" [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
                @for (page of [].constructor(totalPages); track $index) {
                <button class="page-btn" [class.active]="currentPage === $index + 1" (click)="goToPage($index + 1)">{{
                    $index + 1 }}</button>
                }
                <button class="page-btn" [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>
        }
        }
    </div>


    <!-- Create/Edit Modal - Redesigned -->
    @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
        <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2>{{ isEditing() ? 'Ch·ªânh s·ª≠a tuy·∫øn ƒë∆∞·ªùng' : 'Th√™m tuy·∫øn ƒë∆∞·ªùng m·ªõi' }}</h2>
                    <p class="modal-subtitle">Nh·∫≠p th√¥ng tin chi ti·∫øt cho tuy·∫øn v·∫≠n t·∫£i {{ isEditing() ? '' : 'm·ªõi' }}
                        trong h·ªá th·ªëng WeDeLi.</p>
                </div>
                <button class="close-btn" (click)="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Route Name -->
                <div class="form-group full-width">
                    <label>T√™n tuy·∫øn<span class="required">*</span></label>
                    <input type="text" [(ngModel)]="formData.routeName"
                        placeholder="V√≠ d·ª•: H√† N·ªôi - H·∫£i Ph√≤ng (Express)" />
                </div>

                <!-- Origin and Destination Sections -->
                <div class="location-sections">
                    <!-- Origin Section -->
                    <div class="location-section origin">
                        <div class="section-header">
                            <span class="section-icon origin-icon">üìç</span>
                            <span class="section-title">ƒêi·ªÉm ƒëi</span>
                        </div>
                        <div class="section-fields">
                            <div class="form-group">
                                <label>T·ªânh/Th√†nh ph·ªë<span class="required">*</span></label>
                                <select [(ngModel)]="formData.originProvince">
                                    <option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>
                                    @for (province of provinces; track province) {
                                    <option [value]="province">{{ province }}</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Qu·∫≠n/Huy·ªán</label>
                                <select [(ngModel)]="formData.originDistrict">
                                    <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Destination Section -->
                    <div class="location-section destination">
                        <div class="section-header">
                            <span class="section-icon destination-icon">üìç</span>
                            <span class="section-title">ƒêi·ªÉm ƒë·∫øn</span>
                        </div>
                        <div class="section-fields">
                            <div class="form-group">
                                <label>T·ªânh/Th√†nh ph·ªë<span class="required">*</span></label>
                                <select [(ngModel)]="formData.destinationProvince">
                                    <option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>
                                    @for (province of provinces; track province) {
                                    <option [value]="province">{{ province }}</option>
                                    }
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Qu·∫≠n/Huy·ªán</label>
                                <select [(ngModel)]="formData.destinationDistrict">
                                    <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distance and Time -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Kho·∫£ng c√°ch (km) <span class="info-icon"
                                title="T·ª± ƒë·ªông t√≠nh ho·∫∑c nh·∫≠p th·ªß c√¥ng">‚ÑπÔ∏è</span></label>
                        <input type="number" [(ngModel)]="formData.distanceKm" placeholder="0.0" step="0.1" />
                    </div>
                    <div class="form-group">
                        <label>Th·ªùi gian ∆∞·ªõc t√≠nh (gi·ªù) <span class="info-icon"
                                title="Th·ªùi gian di chuy·ªÉn ∆∞·ªõc t√≠nh">‚ÑπÔ∏è</span></label>
                        <input type="number" [(ngModel)]="formData.estimatedDurationHours" placeholder="0.0"
                            step="0.1" />
                    </div>
                </div>

                <!-- Base Price -->
                <div class="price-section">
                    <label class="price-label">Gi√° c∆∞·ªõc c∆° b·∫£n (VNƒê)<span class="required">*</span></label>
                    <div class="price-input-wrapper">
                        <input type="number" [(ngModel)]="formData.basePrice" placeholder="0" class="price-input" />
                        <span class="price-suffix">VNƒê</span>
                    </div>
                </div>

                <!-- Status Toggle -->
                <div class="status-section">
                    <div class="status-info">
                        <span class="status-label">Tr·∫°ng th√°i tuy·∫øn ƒë∆∞·ªùng</span>
                        <span class="status-desc">Cho ph√©p tuy·∫øn n√†y nh·∫≠n ƒë∆°n h√†ng ngay l·∫≠p t·ª©c</span>
                    </div>
                    <label class="toggle-switch-modern">
                        <input type="checkbox" [(ngModel)]="formData.isActive" />
                        <span class="slider-modern"></span>
                        <span class="toggle-label-text">{{ formData.isActive ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng' }}</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="closeModal()">H·ªßy</button>
                <button class="btn btn-primary btn-save" (click)="saveRoute()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    {{ isEditing() ? 'C·∫≠p nh·∫≠t' : 'L∆∞u tuy·∫øn ƒë∆∞·ªùng' }}
                </button>
            </div>
        </div>
    </div>
    }

    <!-- Delete Confirmation Modal -->
    @if (showDeleteModal()) {
    <div class="modal-overlay" (click)="closeModal()">
        <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>X√°c nh·∫≠n x√≥a</h2>
                <button class="close-btn" (click)="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p class="delete-warning">
                    B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tuy·∫øn <strong>{{ selectedRoute?.routeName }}</strong>?
                </p>
                <p class="delete-note">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" (click)="closeModal()">H·ªßy</button>
                <button class="btn btn-danger" (click)="deleteRoute()">X√≥a tuy·∫øn</button>
            </div>
        </div>
    </div>
    }
</div>
<div class="company-customers-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-left">
            <h1>Kh√°ch h√†ng quen thu·ªôc</h1>
            <p class="subtitle">Qu·∫£n l√Ω gi√° ri√™ng cho kh√°ch h√†ng th√¢n thi·∫øt</p>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" (click)="openAddModal()">
                <span class="icon">+</span>
                Th√™m kh√°ch h√†ng
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon customers">üë•</div>
            <div class="stat-info">
                <span class="stat-value">{{ totalCustomers }}</span>
                <span class="stat-label">T·ªïng kh√°ch h√†ng</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon vip">‚≠ê</div>
            <div class="stat-info">
                <span class="stat-value">{{ vipCount }}</span>
                <span class="stat-label">Kh√°ch VIP</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon revenue">üí∞</div>
            <div class="stat-info">
                <span class="stat-value">{{ formatCurrency(totalRevenue) }}</span>
                <span class="stat-label">T·ªïng doanh thu</span>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" placeholder="T√¨m theo t√™n, SƒêT, email..." [value]="searchTerm()"
                (input)="onSearch($event)" />
        </div>
        <button class="filter-btn" [class.active]="filterVipOnly()" (click)="toggleVipFilter()">
            ‚≠ê Ch·ªâ kh√°ch VIP
        </button>
    </div>

    <!-- Loading -->
    @if (isLoading()) {
    <div class="loading-container">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i...</p>
    </div>
    }

    <!-- Empty State -->
    @if (!isLoading() && filteredCustomers().length === 0) {
    <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <h3>Ch∆∞a c√≥ kh√°ch h√†ng quen thu·ªôc</h3>
        <p>Th√™m kh√°ch h√†ng ƒë·∫ßu ti√™n ƒë·ªÉ qu·∫£n l√Ω gi√° ri√™ng</p>
        <button class="btn btn-primary" (click)="openAddModal()">
            Th√™m kh√°ch h√†ng
        </button>
    </div>
    }

    <!-- Customer Table -->
    @if (!isLoading() && filteredCustomers().length > 0) {
    <div class="table-container">
        <table class="customers-table">
            <thead>
                <tr>
                    <th>Kh√°ch h√†ng</th>
                    <th>Li√™n h·ªá</th>
                    <th>ƒê·ªãnh gi√°</th>
                    <th>Th·ªëng k√™</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                @for (customer of filteredCustomers(); track customer.companyCustomerId) {
                <tr>
                    <td class="customer-info">
                        <div class="customer-name">
                            @if (customer.isVip) {
                            <span class="vip-badge">‚≠ê</span>
                            }
                            {{ customer.fullName }}
                        </div>
                        @if (customer.notes) {
                        <div class="customer-notes">{{ customer.notes }}</div>
                        }
                    </td>
                    <td class="contact-info">
                        <div class="phone">üìû {{ customer.phone }}</div>
                        @if (customer.email) {
                        <div class="email">‚úâÔ∏è {{ customer.email }}</div>
                        }
                    </td>
                    <td class="pricing-info">
                        <span class="pricing-badge" [class.custom]="customer.customPrice || customer.discountPercent">
                            {{ customer.pricingDescription }}
                        </span>
                    </td>
                    <td class="stats-info">
                        <div class="stats-row">
                            <span class="stat-item">üì¶ {{ customer.totalOrders }} ƒë∆°n</span>
                            <span class="stat-item">üíµ {{ formatCurrency(customer.totalRevenue) }}</span>
                        </div>
                    </td>
                    <td>
                        <button class="vip-toggle" [class.is-vip]="customer.isVip" (click)="toggleVip(customer)"
                            title="Toggle VIP">
                            {{ customer.isVip ? '‚≠ê VIP' : '‚òÜ Th∆∞·ªùng' }}
                        </button>
                    </td>
                    <td class="actions">
                        <button class="action-btn pricing" (click)="openPricingModal(customer)" title="C·∫≠p nh·∫≠t gi√°">
                            üí≤
                        </button>
                        <button class="action-btn edit" (click)="editCustomer(customer)" title="S·ª≠a">
                            ‚úèÔ∏è
                        </button>
                        <button class="action-btn delete" (click)="deleteCustomer(customer)" title="X√≥a">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
    }
</div>

<!-- Add/Edit Customer Modal -->
@if (showAddModal()) {
<div class="modal-overlay" (click)="closeAddModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>{{ selectedCustomer() ? 'S·ª≠a kh√°ch h√†ng' : 'Th√™m kh√°ch h√†ng quen thu·ªôc' }}</h2>
            <button class="close-btn" (click)="closeAddModal()">√ó</button>
        </div>
        <form [formGroup]="customerForm" (ngSubmit)="saveCustomer()">
            <div class="modal-body">
                <div class="form-group">
                    <label>H·ªç t√™n *</label>
                    <input type="text" formControlName="fullName" placeholder="Nguy·ªÖn VƒÉn A" />
                    @if (customerForm.get('fullName')?.invalid && customerForm.get('fullName')?.touched) {
                    <span class="error">Vui l√≤ng nh·∫≠p h·ªç t√™n</span>
                    }
                </div>

                <div class="form-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i *</label>
                    <input type="tel" formControlName="phone" placeholder="0901234567" />
                    @if (customerForm.get('phone')?.invalid && customerForm.get('phone')?.touched) {
                    <span class="error">S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá</span>
                    }
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" formControlName="email" placeholder="email@example.com" />
                </div>

                <div class="form-row">
                    <div class="form-group half">
                        <label>Gi√° c·ªë ƒë·ªãnh (VND)</label>
                        <input type="number" formControlName="customPrice" placeholder="ƒê·ªÉ tr·ªëng = gi√° m·∫∑c ƒë·ªãnh" />
                    </div>
                    <div class="form-group half">
                        <label>Gi·∫£m gi√° (%)</label>
                        <input type="number" formControlName="discountPercent" placeholder="0-100" min="0" max="100" />
                    </div>
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" formControlName="isVip" />
                        <span>‚≠ê Kh√°ch h√†ng VIP</span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Ghi ch√∫</label>
                    <textarea formControlName="notes" placeholder="Ghi ch√∫ n·ªôi b·ªô..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeAddModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary" [disabled]="customerForm.invalid || isSaving()">
                    {{ isSaving() ? 'ƒêang l∆∞u...' : 'L∆∞u' }}
                </button>
            </div>
        </form>
    </div>
</div>
}

<!-- Pricing Modal -->
@if (showPricingModal()) {
<div class="modal-overlay" (click)="closePricingModal()">
    <div class="modal modal-sm" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>C·∫≠p nh·∫≠t gi√° - {{ selectedCustomer()?.fullName }}</h2>
            <button class="close-btn" (click)="closePricingModal()">√ó</button>
        </div>
        <form [formGroup]="pricingForm" (ngSubmit)="savePricing()">
            <div class="modal-body">
                <div class="pricing-info-box">
                    <p>Gi√° ∆∞u ti√™n: <strong>Gi√° c·ªë ƒë·ªãnh > Gi·∫£m gi√° % > Gi√° m·∫∑c ƒë·ªãnh</strong></p>
                </div>

                <div class="form-group">
                    <label>Gi√° c·ªë ƒë·ªãnh (VND)</label>
                    <input type="number" formControlName="customPrice" placeholder="ƒê·ªÉ tr·ªëng = kh√¥ng √°p d·ª•ng" />
                    <span class="hint">N·∫øu c√≥ gi√° c·ªë ƒë·ªãnh, s·∫Ω b·ªè qua gi·∫£m gi√° %</span>
                </div>

                <div class="form-group">
                    <label>Gi·∫£m gi√° (%)</label>
                    <input type="number" formControlName="discountPercent" placeholder="0-100" min="0" max="100" />
                    <span class="hint">√Åp d·ª•ng khi kh√¥ng c√≥ gi√° c·ªë ƒë·ªãnh</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closePricingModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary" [disabled]="pricingForm.invalid || isSaving()">
                    {{ isSaving() ? 'ƒêang l∆∞u...' : 'C·∫≠p nh·∫≠t gi√°' }}
                </button>
            </div>
        </form>
    </div>
</div>
}
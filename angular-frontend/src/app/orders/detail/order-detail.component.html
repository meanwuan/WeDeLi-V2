<div class="order-detail-page">
    <!-- Header -->
    <div class="page-header">
        <div class="header-left">
            <button class="back-btn" (click)="goBack()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Quay l·∫°i
            </button>
            @if (order()) {
            <div class="order-title">
                <span class="tracking-label">M√£ v·∫≠n ƒë∆°n</span>
                <h1 class="tracking-code">{{ order()!.trackingCode }}</h1>
            </div>
            }
        </div>
        @if (order()) {
        <div class="header-actions">
            <app-status-badge [label]="getStatusLabel(order()!.orderStatus)"
                [variant]="getStatusVariant(order()!.orderStatus)" [showDot]="true" />
            <button class="btn btn-secondary" (click)="copyTrackingCode()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                Sao ch√©p
            </button>
            <button class="btn btn-secondary" (click)="printOrder()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                In phi·∫øu
            </button>
            <button class="btn btn-primary" (click)="editOrder()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Ch·ªânh s·ª≠a
            </button>
        </div>
        }
    </div>

    <!-- Loading State -->
    @if (isLoading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i th√¥ng tin ƒë∆°n h√†ng...</p>
    </div>
    }

    <!-- Error State -->
    @if (error()) {
    <div class="error-state">
        <h3>Kh√¥ng th·ªÉ t·∫£i ƒë∆°n h√†ng</h3>
        <p>{{ error() }}</p>
        <button class="btn btn-primary" (click)="goBack()">Quay l·∫°i danh s√°ch</button>
    </div>
    }

    <!-- Order Content -->
    @if (!isLoading() && order()) {
    <div class="order-content">
        <!-- Status Actions -->
        @if (getAvailableStatuses().length > 0) {
        <div class="status-actions">
            <span class="label">C·∫≠p nh·∫≠t tr·∫°ng th√°i:</span>
            @for (status of getAvailableStatuses(); track status) {
            <button class="status-btn" [class]="status" (click)="updateStatus(status)">
                {{ getStatusLabel(status) }}
            </button>
            }
        </div>
        }

        <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- Sender & Receiver -->
                <div class="section-row">
                    <div class="section">
                        <h3>üë§ Ng∆∞·ªùi g·ª≠i</h3>
                        <div class="info-card">
                            <div class="info-row">
                                <span class="label">H·ªç t√™n</span>
                                <span class="value">{{ order()!.senderName }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">S·ªë ƒëi·ªán tho·∫°i</span>
                                <span class="value">{{ order()!.senderPhone }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">ƒê·ªãa ch·ªâ</span>
                                <span class="value">{{ order()!.senderAddress }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h3>üì¶ Ng∆∞·ªùi nh·∫≠n</h3>
                        <div class="info-card">
                            <div class="info-row">
                                <span class="label">H·ªç t√™n</span>
                                <span class="value">{{ order()!.receiverName }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">S·ªë ƒëi·ªán tho·∫°i</span>
                                <span class="value">{{ order()!.receiverPhone }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">ƒê·ªãa ch·ªâ</span>
                                <span class="value">{{ order()!.receiverAddress }}</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Khu v·ª±c</span>
                                <span class="value">{{ order()!.receiverDistrict }}, {{ order()!.receiverProvince
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parcel Info -->
                <div class="section">
                    <h3>üìã Th√¥ng tin h√†ng h√≥a</h3>
                    <div class="info-card">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="label">Lo·∫°i h√†ng</span>
                                <span class="value">{{ getParcelTypeLabel(order()!.parcelType) }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Kh·ªëi l∆∞·ª£ng</span>
                                <span class="value">{{ order()!.weightKg }} kg</span>
                            </div>
                            @if (order()!.declaredValue) {
                            <div class="info-item">
                                <span class="label">Gi√° tr·ªã khai b√°o</span>
                                <span class="value">{{ formatCurrency(order()!.declaredValue) }}</span>
                            </div>
                            }
                        </div>
                        @if (order()!.specialInstructions) {
                        <div class="info-row instructions">
                            <span class="label">Ghi ch√∫ ƒë·∫∑c bi·ªát</span>
                            <span class="value">{{ order()!.specialInstructions }}</span>
                        </div>
                        }
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="section">
                    <h3>üí≥ Th√¥ng tin thanh to√°n</h3>
                    <div class="info-card payment-card">
                        <div class="payment-row">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                            <span>{{ formatCurrency(order()!.shippingFee) }}</span>
                        </div>
                        @if (order()!.codAmount && order()!.codAmount > 0) {
                        <div class="payment-row cod">
                            <span>Ti·ªÅn thu h·ªô (COD)</span>
                            <span class="cod-amount">{{ formatCurrency(order()!.codAmount) }}</span>
                        </div>
                        }
                        <div class="payment-row total">
                            <span>T·ªïng c·ªông</span>
                            <span>{{ formatCurrency(order()!.shippingFee) }}</span>
                        </div>
                        <div class="payment-info">
                            <div class="info-item">
                                <span class="label">Ph∆∞∆°ng th·ª©c</span>
                                <span class="value">{{ getPaymentMethodLabel(order()!.paymentMethod) }}</span>
                            </div>
                            <div class="info-item">
                                <span class="label">Tr·∫°ng th√°i</span>
                                <span class="value payment-status" [class]="order()!.paymentStatus">
                                    {{ getPaymentStatusLabel(order()!.paymentStatus) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Assignment Info -->
                <div class="section">
                    <h3>üöö Ph√¢n c√¥ng v·∫≠n chuy·ªÉn</h3>
                    <div class="info-card">
                        <div class="assignment-grid">
                            <div class="assignment-item">
                                <div class="icon driver">üë§</div>
                                <div class="details">
                                    <span class="label">T√†i x·∫ø</span>
                                    @if (order()!.driverName) {
                                    <span class="value">{{ order()!.driverName }}</span>
                                    <span class="sub">{{ order()!.driverPhone }}</span>
                                    } @else {
                                    <span class="value empty">Ch∆∞a ph√¢n c√¥ng</span>
                                    }
                                </div>
                            </div>
                            <div class="assignment-item">
                                <div class="icon vehicle">üöõ</div>
                                <div class="details">
                                    <span class="label">Xe</span>
                                    @if (order()!.vehicleLicensePlate) {
                                    <span class="value">{{ order()!.vehicleLicensePlate }}</span>
                                    } @else {
                                    <span class="value empty">Ch∆∞a ph√¢n c√¥ng</span>
                                    }
                                </div>
                            </div>
                            <div class="assignment-item">
                                <div class="icon route">üõ£Ô∏è</div>
                                <div class="details">
                                    <span class="label">Tuy·∫øn ƒë∆∞·ªùng</span>
                                    @if (order()!.routeName) {
                                    <span class="value">{{ order()!.routeName }}</span>
                                    } @else {
                                    <span class="value empty">Ch∆∞a x√°c ƒë·ªãnh</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="section">
                    <h3>üìç L·ªãch s·ª≠ tr·∫°ng th√°i</h3>
                    <div class="info-card timeline-card">
                        <div class="timeline">
                            @if (order()!.statusHistory && order()!.statusHistory!.length > 0) {
                            @for (event of order()!.statusHistory; track event.historyId) {
                            <div class="timeline-item" [class.active]="$first">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <span class="time">{{ formatDateTime(event.createdAt) }}</span>
                                    <span class="status">{{ getStatusLabel(event.newStatus) }}</span>
                                    @if (event.notes) {
                                    <span class="notes">{{ event.notes }}</span>
                                    }
                                    @if (event.location) {
                                    <span class="location">üìç {{ event.location }}</span>
                                    }
                                </div>
                            </div>
                            }
                            } @else {
                            <div class="timeline-item active">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    <span class="time">{{ formatDateTime(order()!.createdAt) }}</span>
                                    <span class="status">ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o</span>
                                </div>
                            </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Timestamps -->
                <div class="section">
                    <h3>üìÖ Th·ªùi gian</h3>
                    <div class="info-card">
                        <div class="info-row">
                            <span class="label">Ng√†y t·∫°o</span>
                            <span class="value">{{ formatDateTime(order()!.createdAt) }}</span>
                        </div>
                        @if (order()!.pickupScheduledAt) {
                        <div class="info-row">
                            <span class="label">H·∫πn l·∫•y h√†ng</span>
                            <span class="value">{{ formatDateTime(order()!.pickupScheduledAt) }}</span>
                        </div>
                        }
                        @if (order()!.pickupConfirmedAt) {
                        <div class="info-row">
                            <span class="label">ƒê√£ l·∫•y h√†ng</span>
                            <span class="value">{{ formatDateTime(order()!.pickupConfirmedAt) }}</span>
                        </div>
                        }
                        @if (order()!.deliveredAt) {
                        <div class="info-row">
                            <span class="label">Giao th√†nh c√¥ng</span>
                            <span class="value success">{{ formatDateTime(order()!.deliveredAt) }}</span>
                        </div>
                        }
                    </div>
                </div>

                <!-- Customer Info -->
                <div class="section">
                    <h3>üë• Th√¥ng tin kh√°ch h√†ng</h3>
                    <div class="info-card">
                        <div class="info-row">
                            <span class="label">T√™n kh√°ch h√†ng</span>
                            <span class="value">{{ order()!.customerName }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">S·ªë ƒëi·ªán tho·∫°i</span>
                            <span class="value">{{ order()!.customerPhone }}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Lo·∫°i kh√°ch</span>
                            <span class="value">
                                @if (order()!.isRegularCustomer) {
                                <span class="badge regular">Kh√°ch quen</span>
                                } @else {
                                <span class="badge">Kh√°ch v√£ng lai</span>
                                }
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</div>